# TOA5 File Server

## Description

This server handles TOA5 weather data files generated by a Campbell Scientific weather station. The server reads, validates, and caches weather data from a `.dat` file, which is updated every 15 minutes. The data is exposed via RESTful API endpoints.

## Features

- **HTTPS**: Secure communication using `mkcert` for development certificates.
- **Input Validation**: Joi schema validation for request data.
- **Rate Limiting**: Protects against brute-force attacks by limiting the number of requests.
- **Helmet**: Sets various HTTP headers for security.
- **CORS**: Configured to allow requests from specific origins.
- **API Key Authentication**: Secures the API endpoints with an API key.
- **File Watching**: Automatically reloads data when the TOA5 file is updated.
- **Error Handling**: Centralized error handling middleware.
- **Logging**: Winston for logging errors and important events.
- **CSRF Protection**: Protects against cross-site request forgery attacks using `csurf`.

## Installation

1. Clone the repository:

   ```bash
   git clone https://github.com/markrusselldev/toa5-file-server.git
   cd toa5-file-server
   ```

2. Install dependencies:

   ```bash
   npm install
   ```

3. Create a `.env` file in the root directory and set your API key:

   ```plaintext
   API_KEY=your_secret_api_key
   ```

4. Install `mkcert` and generate certificates:

   ```bash
   mkcert -install
   mkcert -key-file ./ssl/localhost-key.pem -cert-file ./ssl/localhost.pem localhost
   ```

5. Start the server:
   ```bash
   npm start
   ```

## API Endpoints

### Get Latest Weather Data

- **URL**: `/api/latest`
- **Method**: `GET`
- **Headers**:
  - `x-api-key`: `your_secret_api_key`
  - `X-CSRF-TOKEN`: `csrf_token`
- **Response**:
  ```json
  {
    "TIMESTAMP": "2024-04-06T19:30:00.000Z",
    "RECORD": 0,
    "AirTF_Max": 10.87,
    "AirTF_Min": 10.74,
    "AirTF_Avg": 10.78,
    "WC_F_Avg": 0.553,
    "WS_mph_Max": 12.09,
    "WS_mph_Min": 0,
    "WS_mph_Avg": 7.875,
    "WindDir": 302.5,
    "RH": 88.1,
    "DP_F_Avg": 7.958,
    "BP_inHg_Avg": 28.69,
    "BattV": 14.15,
    "PanelTemp_F": -10.47
  }
  ```

### Get All Weather Data

- **URL**: `/api/data`
- **Method**: `GET`
- **Headers**:
  - `x-api-key`: `your_secret_api_key`
  - `X-CSRF-TOKEN`: `csrf_token`
- **Response**:
  ```json
  [
    {
      "TIMESTAMP": "2024-04-06T19:30:00.000Z",
      "RECORD": 0,
      "AirTF_Max": 10.87,
      "AirTF_Min": 10.74,
      "AirTF_Avg": 10.78,
      "WC_F_Avg": 0.553,
      "WS_mph_Max": 12.09,
      "WS_mph_Min": 0,
      "WS_mph_Avg": 7.875,
      "WindDir": 302.5,
      "RH": 88.1,
      "DP_F_Avg": 7.958,
      "BP_inHg_Avg": 28.69,
      "BattV": 14.15,
      "PanelTemp_F": -10.47
    },
    {
      "TIMESTAMP": "2024-04-06T19:45:00.000Z",
      "RECORD": 1,
      "AirTF_Max": 10.01,
      "AirTF_Min": 9.76,
      "AirTF_Avg": 9.86,
      "WC_F_Avg": -7.825,
      "WS_mph_Max": 29.08,
      "WS_mph_Min": 0,
      "WS_mph_Avg": 20.19,
      "WindDir": 287.7,
      "RH": 87.4,
      "DP_F_Avg": 6.911,
      "BP_inHg_Avg": 29.26,
      "BattV": 14.15,
      "PanelTemp_F": -10.42
    }
    // More records...
  ]
  ```

### Server-Sent Events (SSE) Endpoint

- **URL**: `/api/sse`
- **Method**: `GET`
- **Description**: This endpoint sets up a Server-Sent Events (SSE) connection for real-time updates.

### Health Check

- **URL**: `/api/health`
- **Method**: `GET`
- **Response**:
  ```json
  {
    "status": "UP",
    "version": "1.0.0",
    "uptime": 8.080561855,
    "memoryUsage": {
      "rss": 109449216,
      "heapTotal": 54788096,
      "heapUsed": 32468136,
      "external": 2196388,
      "arrayBuffers": 16795
    },
    "platform": "linux",
    "cpuCount": 4,
    "environment": "development",
    "databaseConnection": "Connected",
    "cacheStatus": {
      "status": "Healthy",
      "cacheSize": 7113,
      "cacheHeaders": ["TIMESTAMP", "RECORD", "AirTF_Max", "AirTF_Min", "AirTF_Avg", "WC_F_Avg", "WS_mph_Max", "WS_mph_Min", "WS_mph_Avg", "WindDir", "RH", "DP_F_Avg", "BP_inHg_Avg", "BattV", "PanelTemp_F"]
    },
    "sseClients": 0
  }
  ```

## Configuration

The server configuration is managed through a `config.json` file which defines the schema of the TOA5 data.

Example `config.json`:

```json
{
  "columns": [
    { "name": "TIMESTAMP", "type": "datetime" },
    { "name": "RECORD", "type": "int" },
    { "name": "AirTF_Max", "type": "float" },
    { "name": "AirTF_Min", "type": "float" },
    { "name": "AirTF_Avg", "type": "float" },
    { "name": "WC_F_Avg", "type": "float" },
    { "name": "WS_mph_Max", "type": "float" },
    { "name": "WS_mph_Min", "type": "float" },
    { "name": "WS_mph_Avg", "type": "float" },
    { "name": "WindDir", "type": "float" },
    { "name": "RH", "type": "float" },
    { "name": "DP_F_Avg", "type": "float" },
    { "name": "BP_inHg_Avg", "type": "float" },
    { "name": "BattV", "type": "float" },
    { "name": "PanelTemp_F", "type": "float" }
  ]
}
```

## ToDo

If the app were to be used on a public web page, consider implementing the following additional security measures:

1. Data Encryption at Rest: Ensure that sensitive data is encrypted when stored in databases or files.
2. Content Security Policy (CSP): Further enhance Helmet configuration to include a strict Content Security Policy.

## License

This project is licensed under the MIT License.
&copy; 2024 Mark David Russell. All rights reserved.
